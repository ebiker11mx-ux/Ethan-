// chat-app.js
// Run: npm init -y && npm install express socket.io
// Then: node chat-app.js
// Open browser at http://localhost:3000

const express = require('express');
const http = require('http');
const { Server } = require('socket.io');
const path = require('path');

// Allowed users and tokens
const ALLOWED_USERS = {
  ethan: 'TOKEN_ETHAN_123',
  partner: 'TOKEN_PARTNER_456',
};

const app = express();
const server = http.createServer(app);
const io = new Server(server);

// Serve client HTML directly
app.get('/', (_req, res) => {
  res.send(`
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Two-person chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #111; color: #eee; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .row { display: flex; gap: 8px; margin-bottom: 12px; }
    input, button { padding: 10px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #eee; }
    input { flex: 1; }
    #chat { border: 1px solid #333; border-radius: 12px; padding: 12px; min-height: 300px; background: #0d0d0d; }
    .msg { margin: 8px 0; }
    .me { color: #8ad; }
    .them { color: #ad8; }
    .sys { color: #aaa; font-size: 0.9em; }
    .typing { font-style: italic; color: #888; height: 20px; }
    .presence { font-size: 0.9em; color: #bbb; margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Private chat</h2>

    <div class="row">
      <input id="username" placeholder="Username (ethan or partner)" />
      <input id="token" placeholder="Token" />
      <button id="connectBtn">Connect</button>
    </div>

    <div id="presence" class="presence"></div>
    <div id="typing" class="typing"></div>
    <div id="chat"></div>

    <div class="row">
      <input id="messageInput" placeholder="Type a message..." disabled />
      <button id="sendBtn" disabled>Send</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    let socket = null;
    const chat = document.getElementById('chat');
    const typingEl = document.getElementById('typing');
    const presenceEl = document.getElementById('presence');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    function addLine(text, cls = 'sys') {
      const div = document.createElement('div');
      div.className = \`msg \${cls}\`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    document.getElementById('connectBtn').onclick = () => {
      const username = document.getElementById('username').value.trim();
      const token = document.getElementById('token').value.trim();
      if (!username || !token) return alert('Enter username and token');

      socket = io('/', { auth: { username, token } });

      socket.on('connect', () => {
        addLine('Connected', 'sys');
        messageInput.disabled = false;
        sendBtn.disabled = false;
      });

      socket.on('connect_error', (err) => {
        addLine('Auth error: ' + err.message, 'sys');
      });

      socket.on('presence', (p) => {
        presenceEl.textContent = \`Status: \${p.user} is \${p.type}. Online: \${p.onlineUsers.join(', ')}\`;
      });

      socket.on('typing', ({ user, isTyping }) => {
        typingEl.textContent = isTyping ? \`\${user} is typing...\` : '';
      });

      socket.on('message', (msg) => {
        const me = document.getElementById('username').value.trim();
        const who = msg.from === me ? 'me' : 'them';
        const time = new Date(msg.timestamp).toLocaleTimeString();
        addLine(\`[\${time}] \${msg.from}: \${msg.text}\`, who);
      });
    };

    messageInput.addEventListener('input', () => {
      if (socket && socket.connected) {
        socket.emit('typing', messageInput.value.length > 0);
      }
    });

    sendBtn.onclick = () => {
      const text = messageInput.value.trim();
      if (!text || !socket || !socket.connected) return;
      socket.emit('message', { text });
      messageInput.value = '';
      socket.emit('typing', false);
    };
  </script>
</body>
</html>
  `);
});

// Auth middleware
io.use((socket, next) => {
  const { username, token } = socket.handshake.auth || {};
  if (!username || !token) return next(new Error('Missing auth'));
  const valid = ALLOWED_USERS[username] === token;
  if (!valid) return next(new Error('Unauthorized'));
  socket.data.username = username;
  return next();
});

let onlineUsers = new Set();

io.on('connection', (socket) => {
  const user = socket.data.username;
  onlineUsers.add(user);

  socket.broadcast.emit('presence', {
    type: 'online',
    user,
    onlineUsers: Array.from(onlineUsers),
  });

  socket.on('message', (payload) => {
    const msg = {
      from: user,
      text: payload?.text || '',
      timestamp: payload?.timestamp || Date.now(),
    };
    socket.broadcast.emit('message', msg);
    socket.emit('message', msg);
  });

  socket.on('typing', (isTyping) => {
    socket.broadcast.emit('typing', { user, isTyping: !!isTyping });
  });

  socket.on('disconnect', () => {
    onlineUsers.delete(user);
    socket.broadcast.emit('presence', {
      type: 'offline',
      user,
      onlineUsers: Array.from(onlineUsers),
    });
  });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
  console.log(\`Chat app running at http://localhost:\${PORT}\`);
});                                                                                                                                                                                                                                                                                                                                              int caught = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for (int i=0;i<s.Traps;i++) if (rand01() < 0.35) caught++;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                s.Food += caught;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (caught > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cout << "Your traps caught " << caught << " food.\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                       int coldDmg = max(0, 8 - s.Shelter);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        s.Health -= coldDmg;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cout << "A cold wind howls (-" << coldDmg << " health).\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Wolves
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            double wolfBase = 0.10 + (s.Night * 0.005);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (rand01() < wolfBase) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                int dmg = max(2, 18 - (s.Shelter * 2));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            s.Health -= dmg;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cout << "Wolves circle your camp! (-" << dmg << " health)\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (s.Wood >= 2) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    s.Wood -= 2;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cout << "You burn extra wood to deter them (-2 wood).\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Starvation / fatigue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (s.Hunger >= 90) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    s.Health -= 8;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cout << "Starvation gnaws at you (-8 health).\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (s.Energy <= 10) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            s.Health -= 5;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cout << "Exhaustion sets in (-5 health).\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    struct Game {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Stats s;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int actionsLeft = 2; // day actions per day
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                string phase = "Day"; // "Day" or "Night"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                void renderHUD(const Stats& s) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cout << "\n=== Forest 99 ===\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cout << "Night: " << s.Night << "\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cout << "Health: " << s.Health << " | Hunger: " << s.Hunger << " | Energy: " << s.Energy << "\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cout << "Wood: " << s.Wood << " | Food: " << s.Food << " | Shelter: " << s.Shelter << " | Traps: " << s.Traps << "\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                void renderActions(int actionsLeft) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cout << "\nActions left: " << actionsLeft << "\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cout << "1) GatherWood\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cout << "2) Forage\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cout << "3) Rest\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cout << "4) Cook\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cout << "5) CraftShelter\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cout << "6) SetTrap\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cout << "7) EatNow\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cout << "8) Scout\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cout << "9) Skip\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cout << "Choose: ";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bool handleAction
