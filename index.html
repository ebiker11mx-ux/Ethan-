<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>3D Obstacle Course – Levels & Double Jump</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>

<style>
html, body {
  width:100%; height:100%; margin:0; overflow:hidden;
  background:#0b0f1a; font-family:system-ui;
}
#renderCanvas { width:100%; height:100%; touch-action:none; display:block; }

.hud { position:fixed; inset:0; pointer-events:none; }
.button {
  position:absolute; pointer-events:auto;
  border:none; color:white; font-weight:700;
  border-radius:14px;
  background:linear-gradient(135deg,#1e88e5,#6a1b9a);
}
#restartBtn { top:16px; left:16px; padding:10px 14px; }
#jumpBtn {
  bottom:28px; right:24px; width:74px; height:74px;
  border-radius:50%;
}
#joystick {
  position:absolute; bottom:22px; left:22px;
  width:140px; height:140px; pointer-events:auto;
}
.joy-bg { width:100%; height:100%; border-radius:50%;
  background:rgba(255,255,255,.08); }
.joy-stick {
  position:absolute; left:50%; top:50%;
  width:70px; height:70px;
  transform:translate(-50%,-50%);
  border-radius:50%;
  background:rgba(255,255,255,.18);
}
#info {
  position:absolute; top:16px; right:16px;
  color:#bfe9ff; font-size:12px;
  background:rgba(0,0,0,.35);
  padding:8px 10px; border-radius:10px;
}
#winBanner {
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:rgba(0,0,0,.7);
  padding:18px 22px;
  border-radius:12px;
  display:none;
}
</style>
</head>

<body>
<canvas id="renderCanvas"></canvas>

<div class="hud">
  <button id="restartBtn" class="button">Restart</button>
  <button id="jumpBtn" class="button">Jump</button>

  <div id="joystick">
    <div class="joy-bg"></div>
    <div class="joy-stick" id="joyStick"></div>
  </div>

  <div id="winBanner">
    Level Complete!<br>
    <small>Next level loading…</small>
  </div>

  <div id="info">
    Level: <span id="level">1</span><br>
    Time: <span id="timer">0.0</span>s
  </div>
</div>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas,true);

let scene, player, cam;
let levelPlatforms=[], movingPlatforms=[], rotatingBars=[], goalTrigger;
let startTime=0, won=false, currentLevel=1;

/* ================= PLAYER ================= */
const playerState = {
  radius:0.5,
  pos:new BABYLON.Vector3(0,2,0),
  vel:new BABYLON.Vector3(),
  speed:7.5,
  jumpPower:10.5,
  gravity:-22,
  grounded:false,
  maxJumps:2,
  jumpsLeft:2
};

/* ================= INPUT ================= */
const keys={w:0,a:0,s:0,d:0};
const joy={active:false,dx:0,dy:0,max:55};

window.addEventListener("keydown",e=>{
  if(e.key==="w")keys.w=1;
  if(e.key==="s")keys.s=1;
  if(e.key==="a")keys.a=1;
  if(e.key==="d")keys.d=1;
  if(e.key===" ")tryJump();
});
window.addEventListener("keyup",e=>{
  if(e.key==="w")keys.w=0;
  if(e.key==="s")keys.s=0;
  if(e.key==="a")keys.a=0;
  if(e.key==="d")keys.d=0;
});

document.getElementById("jumpBtn").onclick=tryJump;
document.getElementById("restartBtn").onclick=()=>resetGame();

/* ================= SCENE ================= */
scene=new BABYLON.Scene(engine);
scene.clearColor=new BABYLON.Color4(.03,.05,.1,1);

new BABYLON.HemisphericLight("h",new BABYLON.Vector3(0,1,0),scene);
player=BABYLON.MeshBuilder.CreateSphere("p",{diameter:1},scene);
player.position.copyFrom(playerState.pos);

cam=new BABYLON.FollowCamera("c",player.position,scene);
cam.radius=12; cam.heightOffset=4.5; cam.lockedTarget=player;
cam.attachControl(canvas,true);

/* ================= LEVEL ================= */
function clearLevel(){
  [...levelPlatforms,
   ...movingPlatforms.map(m=>m.mesh),
   ...rotatingBars.map(r=>r.mesh),
   goalTrigger].forEach(m=>m&&m.dispose());
  levelPlatforms=[]; movingPlatforms=[]; rotatingBars=[];
}

function buildLevel(level){
  clearLevel();
  document.getElementById("level").textContent=level;

  const diff=level-1;
  const size=Math.max(3,6-diff*.5);

  levelPlatforms.push(makePlat(0,0,0,14,14));

  let z=10;
  for(let i=0;i<6;i++){
    levelPlatforms.push(makePlat(0,.5,z,size,size));
    z+=10;
  }

  const mp=makePlat(0,1.2,z,6,6,"#e6a86b");
  movingPlatforms.push({mesh:mp,amp:5+diff,spd:1.2+diff*.4,ph:0});
  z+=14;

  const bar=BABYLON.MeshBuilder.CreateBox("b",{width:1,height:.6,depth:12},scene);
  bar.position.set(0,1.6,z);
  rotatingBars.push({mesh:bar,spd:1.3+diff*.5});

  z+=14;
  for(let i=0;i<6;i++){
    levelPlatforms.push(makePlat(i%2?2.5:-2.5,1,z,size,size));
    z+=6;
  }

  levelPlatforms.push(makePlat(0,1,z,10,10));
  goalTrigger=BABYLON.MeshBuilder.CreateBox("g",{size:6},scene);
  goalTrigger.position.set(0,2,z);
}

function makePlat(x,y,z,w,d,color="#3569a4"){
  const m=BABYLON.MeshBuilder.CreateBox("p",{width:w,height:.8,depth:d},scene);
  m.position.set(x,y,z);
  const mat=new BABYLON.StandardMaterial("m",scene);
  mat.diffuseColor=BABYLON.Color3.FromHexString(color);
  m.material=mat;
  return m;
}

/* ================= GAME LOOP ================= */
function tryJump(){
  if(playerState.jumpsLeft>0){
    playerState.vel.y=playerState.jumpPower;
    playerState.jumpsLeft--;
    playerState.grounded=false;
  }
}

function resetGame(){
  currentLevel=1;
  buildLevel(currentLevel);
  playerState.pos.set(0,2,0);
  playerState.vel.set(0,0,0);
  startTime=performance.now();
}

engine.runRenderLoop(()=>{
  const dt=engine.getDeltaTime()/1000;
  if(won)return;

  document.getElementById("timer").textContent=
    ((performance.now()-startTime)/1000).toFixed(1);

  movingPlatforms.forEach(m=>{
    m.ph+=dt*m.spd;
    m.mesh.position.x=Math.sin(m.ph)*m.amp;
  });
  rotatingBars.forEach(r=>r.mesh.rotation.y+=dt*r.spd);

  const mx=keys.d-keys.a;
  const mz=keys.w-keys.s;
  playerState.vel.x=mx*playerState.speed;
  playerState.vel.z=mz*playerState.speed;
  playerState.vel.y+=playerState.gravity*dt;

  playerState.pos.addInPlace(playerState.vel.scale(dt));
  player.position.copyFrom(playerState.pos);

  levelPlatforms.forEach(p=>{
    if(player.intersectsMesh(p,false) && playerState.vel.y<=0){
      playerState.pos.y=p.position.y+1.2;
      playerState.vel.y=0;
      playerState.grounded=true;
      playerState.jumpsLeft=playerState.maxJumps;
    }
  });

  if(player.intersectsMesh(goalTrigger,false)){
    won=true;
    document.getElementById("winBanner").style.display="block";
    setTimeout(()=>{
      won=false;
      document.getElementById("winBanner").style.display="none";
      currentLevel++;
      buildLevel(currentLevel);
      playerState.pos.set(0,2,0);
      playerState.vel.set(0,0,0);
      startTime=performance.now();
    },1200);
  }
});

buildLevel(1);
startTime=performance.now();
</script>
</body>
</html>
