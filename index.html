// chat-app.js
// Usage:
//   npm init -y
//   npm install express socket.io
//   node chat-app.js
// Then open http://localhost:3000 in a browser

const express = require('express');
const http = require('http');
const { Server } = require('socket.io');

// Allowed tokens (only these two can connect)
const ALLOWED_TOKENS = ['2811', '2009'];

const app = express();
const server = http.createServer(app);
const io = new Server(server);

// Serve client HTML directly
app.get('/', (_req, res) => {
  res.send(`<!doctype html>
  <html lang="en">
  <head>
    <meta charset="utf-8" />
      <title>Two-person chat</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
          <style>
              body { font-family: system-ui, sans-serif; margin: 0; background: #111; color: #eee; }
                  .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
                      .row { display: flex; gap: 8px; margin-bottom: 12px; }
                          input, button { padding: 10px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #eee; }
                              input { flex: 1; }
                                  #chat { border: 1px solid #333; border-radius: 12px; padding: 12px; min-height: 300px; background: #0d0d0d; }
                                      .msg { margin: 8px 0; }
                                          .me { color: #8ad; }
                                              .them { color: #ad8; }
                                                  .sys { color: #aaa; font-size: 0.9em; }
                                                      .typing { font-style: italic; color: #888; height: 20px; }
                                                          .presence { font-size: 0.9em; color: #bbb; margin-bottom: 8px; }
                                                            </style>
                                                            </head>
                                                            <body>
                                                              <div class="wrap">
                                                                  <h2>Private chat</h2>

                                                                      <div class="row">
                                                                            <input id="token" placeholder="Enter your token (2811 or 2009)" />
                                                                                  <button id="connectBtn">Connect</button>
                                                                                      </div>

                                                                                          <div id="presence" class="presence"></div>
                                                                                              <div id="typing" class="typing"></div>
                                                                                                  <div id="chat"></div>

                                                                                                      <div class="row">
                                                                                                            <input id="messageInput" placeholder="Type a message..." disabled />
                                                                                                                  <button id="sendBtn" disabled>Send</button>
                                                                                                                      </div>
                                                                                                                        </div>

                                                                                                                          <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
                                                                                                                            <script>
                                                                                                                                let socket = null;
                                                                                                                                    let myToken = null;
                                                                                                                                        const chat = document.getElementById('chat');
                                                                                                                                            const typingEl = document.getElementById('typing');
                                                                                                                                                const presenceEl = document.getElementById('presence');
                                                                                                                                                    const messageInput = document.getElementById('messageInput');
                                                                                                                                                        const sendBtn = document.getElementById('sendBtn');

                                                                                                                                                            function addLine(text, cls = 'sys') {
                                                                                                                                                                  const div = document.createElement('div');
                                                                                                                                                                        div.className = \`msg \${cls}\`;
                                                                                                                                                                              div.textContent = text;
                                                                                                                                                                                    chat.appendChild(div);
                                                                                                                                                                                          chat.scrollTop = chat.scrollHeight;
                                                                                                                                                                                              }

                                                                                                                                                                                                  document.getElementById('connectBtn').onclick = () => {
                                                                                                                                                                                                        myToken = document.getElementById('token').value.trim();
                                                                                                                                                                                                              if (!myToken) return alert('Enter your token');

                                                                                                                                                                                                                    socket = io(window.location.origin, { auth: { token: myToken } });

                                                                                                                                                                                                                          socket.on('connect', () => {
                                                                                                                                                                                                                                  addLine('Connected', 'sys');
                                                                                                                                                                                                                                          messageInput.disabled = false;
                                                                                                                                                                                                                                                  sendBtn.disabled = false;
                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                              socket.on('connect_error', (err) => {
                                                                                                                                                                                                                                                                      addLine('Auth error: ' + err.message, 'sys');
                                                                                                                                                                                                                                                                            });

                                                                                                                                                                                                                                                                                  socket.on('presence', (p) => {
                                                                                                                                                                                                                                                                                          presenceEl.textContent = \`Status: \${p.user} is \${p.type}. Online: \${p.onlineUsers.join(', ')}\`;
                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                      socket.on('typing', ({ user, isTyping }) => {
                                                                                                                                                                                                                                                                                                              typingEl.textContent = isTyping ? \`\${user} is typing...\` : '';
                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                          socket.on('message', (msg) => {
                                                                                                                                                                                                                                                                                                                                  const who = msg.from === myToken ? 'me' : 'them';
                                                                                                                                                                                                                                                                                                                                          const time = new Date(msg.timestamp).toLocaleTimeString();
                                                                                                                                                                                                                                                                                                                                                  addLine(\`[\${time}] \${msg.from}: \${msg.text}\`, who);
                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                            };

                                                                                                                                                                                                                                                                                                                                                                messageInput.addEventListener('input', () => {
                                                                                                                                                                                                                                                                                                                                                                      if (socket && socket.connected) {
                                                                                                                                                                                                                                                                                                                                                                              socket.emit('typing', messageInput.value.length > 0);
                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                            sendBtn.onclick = () => {
                                                                                                                                                                                                                                                                                                                                                                                                  const text = messageInput.value.trim();
                                                                                                                                                                                                                                                                                                                                                                                                        if (!text || !socket || !socket.connected) return;
                                                                                                                                                                                                                                                                                                                                                                                                              socket.emit('message', { text });
                                                                                                                                                                                                                                                                                                                                                                                                                    messageInput.value = '';
                                                                                                                                                                                                                                                                                                                                                                                                                          socket.emit('typing', false);
                                                                                                                                                                                                                                                                                                                                                                                                                              };
                                                                                                                                                                                                                                                                                                                                                                                                                                </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                </html>`);
                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                // Auth middleware
                                                                                                                                                                                                                                                                                                                                                                                                                                io.use((socket, next) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                  const { token } = socket.handshake.auth || {};
                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!token) return next(new Error('Missing token'));
                                                                                                                                                                                                                                                                                                                                                                                                                                      const valid = ALLOWED_TOKENS.includes(token);
                                                                                                                                                                                                                                                                                                                                                                                                                                        if (!valid) return next(new Error('Unauthorized'));
                                                                                                                                                                                                                                                                                                                                                                                                                                          socket.data.token = token;
                                                                                                                                                                                                                                                                                                                                                                                                                                            return next();
                                                                                                                                                                                                                                                                                                                                                                                                                                            });

                                                                                                                                                                                                                                                                                                                                                                                                                                            let onlineUsers = new Set();

                                                                                                                                                                                                                                                                                                                                                                                                                                            io.on('connection', (socket) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                              const user = socket.data.token;
                                                                                                                                                                                                                                                                                                                                                                                                                                                onlineUsers.add(user);

                                                                                                                                                                                                                                                                                                                                                                                                                                                  socket.broadcast.emit('presence', {
                                                                                                                                                                                                                                                                                                                                                                                                                                                      type: 'online',
                                                                                                                                                                                                                                                                                                                                                                                                                                                          user,
                                                                                                                                                                                                                                                                                                                                                                                                                                                              onlineUsers: Array.from(onlineUsers),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                  socket.on('message', (payload) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const msg = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            from: user,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  text: payload?.text || '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        timestamp: payload?.timestamp || Date.now(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                socket.broadcast.emit('message', msg);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    socket.emit('message', msg);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        socket.on('typing', (isTyping) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            socket.broadcast.emit('typing', { user, isTyping: !!isTyping });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                socket.on('disconnect', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    onlineUsers.delete(user);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        socket.broadcast.emit('presence', {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              type: 'offline',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    user,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          onlineUsers: Array.from(onlineUsers),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const PORT = process.env.PORT || 3000;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                server.listen(PORT, () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  console.log(\`Chat app running at http://localhost:\${PORT}\`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  });