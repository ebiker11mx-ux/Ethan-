<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3D Obby with Coins</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    html,body { margin:0; height:100%; background:#0b0d12; font-family:system-ui, Arial, sans-serif; }
    #hud {
      position:fixed; top:10px; left:10px; color:#eaf2ff; z-index:10;
      background:rgba(0,0,0,0.35); padding:10px 12px; border-radius:8px; backdrop-filter: blur(4px);
      display:flex; gap:12px; align-items:center; font-size:14px;
    }
    #hud .pill { background:rgba(255,255,255,0.1); padding:6px 8px; border-radius:999px; }
    #centerHint {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      color:#c9d7ff; z-index:10; background:rgba(0,0,0,0.45); padding:14px 18px; border-radius:10px; text-align:center;
      max-width:560px; line-height:1.4;
    }
    #startBtn {
      margin-top:10px; padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600;
      background:#5a84ff; color:#fff;
    }
    #mobileControls {
      position:fixed; bottom:18px; left:18px; right:18px; display:flex; justify-content:space-between; z-index:10;
      pointer-events:auto; user-select:none;
    }
    .pad {
      display:grid; grid-template-columns:repeat(3,48px); grid-template-rows:repeat(3,48px); gap:6px;
      background:rgba(0,0,0,0.25); padding:10px; border-radius:14px;
    }
    .btn {
      width:48px; height:48px; background:rgba(255,255,255,0.09); border:1px solid rgba(255,255,255,0.15);
      border-radius:12px; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; touch-action:none;
    }
    .btn:active { background:rgba(255,255,255,0.22); }
    #jumpBtn {
      width:76px; height:76px; border-radius:999px; background:#59d38a; border:none; color:#052; font-weight:800;
      display:flex; align-items:center; justify-content:center;
    }
    #canvas { display:block; width:100vw; height:100vh; }
  </style>
</head>
<body>
  <div id="hud">
    <div class="pill">Level: <span id="levelLabel">1</span></div>
    <div class="pill">Time: <span id="timeLabel">0.0s</span></div>
    <div class="pill">Deaths: <span id="deathsLabel">0</span></div>
    <div class="pill">Jumps: <span id="jumpsLabel">0</span></div>
    <div class="pill">Coins: <span id="coinsLabel">0</span></div>
  </div>

  <div id="centerHint">
    <div style="font-size:18px; font-weight:700; margin-bottom:6px;">3D Obby</div>
    <div>Desktop: Click Start, move mouse to look, WASD to move, Space to jump.<br/>Mobile: Use on‑screen controls, drag to look.</div>
    <button id="startBtn">Start</button>
    <div style="margin-top:8px; opacity:0.8;">Tip: Reach the glowing goal to finish the level.</div>
  </div>

  <div id="mobileControls" style="display:none;">
    <div class="pad" id="movePad">
      <div></div><div class="btn" data-dir="forward">↑</div><div></div>
      <div class="btn" data-dir="left">←</div><div></div><div class="btn" data-dir="right">→</div>
      <div></div><div class="btn" data-dir="back">↓</div><div></div>
    </div>
    <button id="jumpBtn">JUMP</button>
  </div>

  <canvas id="canvas"></canvas>

  <!-- Three.js CDN -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

  <script>
  (() => {
    const canvas = document.getElementById('canvas');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.75));
    renderer.setSize(window.innerWidth, window.innerHeight);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0d12);

    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 500);
    camera.position.set(0, 1.6, 4);

    const hemi = new THREE.HemisphereLight(0xffffff, 0x334466, 0.8);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(6, 12, 8);
    scene.add(dir);

    // Materials
    const matGround = new THREE.MeshStandardMaterial({ color: 0x1c2433, roughness: 1 });
    const matPlatform = new THREE.MeshStandardMaterial({ color: 0x5a84ff, emissive: 0x101626 });
    const matDanger = new THREE.MeshStandardMaterial({ color: 0xff5a5a, emissive: 0x260000 });
    const matGoal = new THREE.MeshStandardMaterial({ color: 0x59d38a, emissive: 0x143321 });
    const matCheckpoint = new THREE.MeshStandardMaterial({ color: 0xf0c94c, emissive: 0x3a2f12 });
    const matPlayer = new THREE.MeshStandardMaterial({ color: 0xeaf2ff, emissive: 0x10161f });
    const matCoin = new THREE.MeshPhongMaterial({ color: 0xffd700, shininess: 100 });

    const floor = new THREE.Mesh(new THREE.BoxGeometry(80, 1, 80), matGround);
    floor.position.set(0, -0.5, 0);
    scene.add(floor);

    const playerSize = new THREE.Vector3(0.6, 1.2, 0.6);
    const player = new THREE.Mesh(new THREE.BoxGeometry(playerSize.x, playerSize.y, playerSize.z), matPlayer);
    scene.add(player);

    const cameraOffset = new THREE.Vector3(0, 0.7, 0);

    let yaw = 0, pitch = 0;
    let vel = new THREE.Vector3();
    let onGround = false;
    let jumps = 0, deaths = 0, coinsCollected = 0;
    let lastCheckpoint = new THREE.Vector3(0, 1, 0);

    const keys = { forward:false, back:false, left:false, right:false, jump:false };
    const mobile = ('ontouchstart' in window);

    // HUD
    const levelLabel = document.getElementById('levelLabel');
    const timeLabel = document.getElementById('timeLabel');
    const deathsLabel = document.getElementById('deathsLabel');
    const jumpsLabel = document.getElementById('jumpsLabel');
    const coinsLabel = document.getElementById('coinsLabel');

    let levelIndex = 0;
    let levelStartTime = performance.now();

    function updateHUD() {
      levelLabel.textContent = (levelIndex+1);
      const t = (performance.now() - levelStartTime) / 1000;
      timeLabel.textContent = t.toFixed(1) + 's';
      deathsLabel.textContent = deaths;
      jumpsLabel.textContent = jumps;
      coinsLabel.textContent = coinsCollected;
    }

    function makeBox(w,h,d, mat, x=0,y=0,z=0) {
      const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), mat);
      m.position.set(x,y,z);
      scene.add(m);
      return m;
    }
    function makeCoin(x,y,z) {
      const m = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.1,24), matCoin);
      m
